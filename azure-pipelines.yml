trigger:
  - main

pool:
  vmImage: "ubuntu-latest"

stages:
  - stage: "Build"
    jobs:
      - job: "Build"
        steps:
          - task: NodeTool@0
            displayName: "Install Node.js v20"
            inputs:
              versionSpec: "20.x"

          - script: |
              npm --prefix client install
            displayName: "Install frontend dependencies"

          - script: |
              npm install
            displayName: "Install server dependencies"

          - script: |
              npm --prefix client run build
            displayName: "Build the frontend"

          - task: CopyFiles@2
            displayName: "Copy build"
            inputs:
              contents: "client/dist/**"
              targetFolder: "$(Build.ArtifactStagingDirectory)"

          - task: CopyFiles@2
            inputs:
              contents: |
                .env
                package.json
                server.js
                server/**
                database/**
                node_modules/**
              targetFolder: "$(Build.ArtifactStagingDirectory)"
            displayName: "Copy server components"

          - publish: "$(Build.ArtifactStagingDirectory)"
            displayName: "Publish Components to next stage"
            artifact: drop

  - stage: "Test"
    dependsOn: "Build"
    condition:  succeeded()
    jobs:
      - job: "Test"
        steps:
          - checkout: none

          - download: current
            artifact: drop
            
          - script: npm --prefix ../app test
            displayName: "Running Tests"
          
          - task: PublishCodeCoverageResults@2
            displayName: "Publishing Code Coverage"
            inputs:
              summaryFileLocation: '**'

  - stage: "Deploy"
    dependsOn: "Test"
    condition:  succeeded()
    jobs:
      - job: "Deploy"
        steps:
          - checkout: none

          - download: current
            artifact: drop

          - task: ArchiveFiles@2
            displayName: "Packaging files into zip"
            inputs:
              rootFolderOrFile: "$(Pipeline.Workspace)/dropApp"
              includeRootFolder: false
              archiveType: "zip"
              archiveFile: "$(Build.ArtifactStagingDirectory)/drop.zip"
              replaceExistingArchive: true

          - task: AzureWebApp@1
            displayName: "Deploy to server"
            inputs:
              azureSubscription: "ServeSpot-RM"
              appType: "webApp"
              appName: "ServeSpot"
              package: "$(Build.ArtifactStagingDirectory)/*.zip"
              customWebConfig: "-appType node"
              deploymentMethod: "runFromPackage"
